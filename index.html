<!-- Wants: Last update text above table top left; Sort by artist name (A-Z/Z-A), by year of release, year of pressing, price of acquisition, date of acquisition, rating, rating info, custom star rating icon + gray stars for /7, choose random release and highlight it animation, arrows movement box covering texts, row different shade of yellow when selecting it with arrows --> 

<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CD Collection</title>
    <link rel="stylesheet" href="selfpage.css?cb=45" />
</head>
<body>
    <div class="container">
    <!-- <div class="banner">
            <img src="banner2.png" alt="Banner">
        </div> -->

        <div class="header">
            <h2>
                <span id="release-header">
                    <span class="release-header-controls">
                        Release
                        <button id="sort-artist-btn" class="sort-button">▼</button>
                        <button id="release-search-toggle" class="search-toggle-button" aria-label="Search albums or artists" title="Search albums or artists"></button>
                        <span id="release-search-panel" class="release-search-panel" aria-hidden="true">
                            <input id="album-search-input" class="album-search-input" type="text" placeholder="Search albums or artists..." aria-label="Search albums or artists">
                        </span>
                    </span>
                </span>
                <span>Catalog</span>
                <span id="identification-header">Identification <button id="sort-year-btn" class="sort-button">▼</button></span>
                <span id="acquisition-header">Acquisition Details <button id="sort-date-btn" class="sort-button">▼</button><button id="sort-price-btn" class="sort-button" aria-label="Sort by price"></button></span>
                <span id="rating-header" style="cursor: pointer;" title="Click to see rating meanings">Personal Rating <button id="sort-rating-btn" class="sort-button">▼</button></span>
            </h2>
        </div>

        <div class="table-wrapper">
            <table class="cd-table">
                <colgroup>
                    <col style="width:20%">
                    <col style="width:26%">
                    <col style="width:26%">
                    <col style="width:18%">
                    <col style="width:10%">
                </colgroup>
                <tbody id="cdTableBody">
                    <!-- Rows will be generated by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Rating Info Popup -->
    <div id="ratingPopup" class="rating-popup">
        <div class="rating-popup-content">
            <span class="rating-close">&times;</span>
            <h3>Personal Rating Scale</h3>
            <div class="rating-scale">
                <div class="rating-item">
                    <span class="rating-number">7</span>
                    <span class="rating-label">Favourite</span>
                </div>
                <div class="rating-item">
                    <span class="rating-number">6</span>
                    <span class="rating-label">Amazing</span>
                </div>
                <div class="rating-item">
                    <span class="rating-number">5</span>
                    <span class="rating-label">Very Good</span>
                </div>
                <div class="rating-item">
                    <span class="rating-number">4</span>
                    <span class="rating-label">Good</span>
                </div>
                <div class="rating-item">
                    <span class="rating-number">3</span>
                    <span class="rating-label">Decent</span>
                </div>
                <div class="rating-item">
                    <span class="rating-number">2</span>
                    <span class="rating-label">Subpar</span>
                </div>
                <div class="rating-item">
                    <span class="rating-number">1</span>
                    <span class="rating-label">Bad</span>
                </div>
                <div class="rating-item">
                    <span class="rating-number">0</span>
                    <span class="rating-label">Awful</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Rating Popup functionality
        const ratingHeader = document.getElementById('rating-header');
        const ratingPopup = document.getElementById('ratingPopup');
        const ratingClose = document.querySelector('.rating-close');

        ratingHeader.addEventListener('click', function(e) {
            // Don't trigger if clicking the sort button
            if (e.target.id === 'sort-rating-btn' || e.target.closest('button')) {
                return;
            }
            ratingPopup.classList.add('show');
        });

        ratingClose.addEventListener('click', function() {
            ratingPopup.classList.remove('show');
        });

        window.addEventListener('click', function(e) {
            if (e.target === ratingPopup) {
                ratingPopup.classList.remove('show');
            }
        });

        // Sort state
        let sortAscendingArtist = true;
        let sortAscendingYear = false;
        let sortAscendingDate = true;
        let sortAscendingPrice = true;
        let sortAscendingRating = true;
        let cachedData = null;

        // Function to generate stars from rating (1-7) using PNG images
        function generateStars(rating) {
            if (!rating) return '';
            
            // Check if rating is "Pending" - just return empty string
            if (String(rating).toLowerCase().trim() === 'pending') {
                return '';
            }
            
            const ratingNum = parseFloat(rating);
            const fullStars = Math.floor(ratingNum);
            const hasHalf = ratingNum % 1 !== 0;
            const emptyStars = 7 - fullStars - (hasHalf ? 1 : 0);
            
            let html = '';
            
            // Full stars
            for (let i = 0; i < fullStars; i++) {
                html += '<img src="Full_Star.png" alt="full star" class="star-icon">';
            }
            
            // Half star if exists
            if (hasHalf) {
                html += '<img src="Half_Star.png" alt="half star" class="star-icon">';
            }
            
            // Empty stars
            for (let i = 0; i < emptyStars; i++) {
                html += '<img src="Empty_Star.png" alt="empty star" class="star-icon">';
            }
            
            return html;
        }

        // Format price to always include € when applicable, using comma as decimal separator
        function formatPrice(price) {
            if (price === null || price === undefined) return '-';
            if (price === '-' || price === '') return '';
            // If it's already a string containing € return trimmed value
            if (typeof price === 'string') {
                const trimmed = price.trim();
                if (trimmed.endsWith('€')) return trimmed;
                const num = Number(trimmed);
                if (!isNaN(num)) {
                    return num.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '€';
                }
                return trimmed + '€';
            }
            if (typeof price === 'number') {
                return price.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '€';
            }
            return String(price) + '€';
        }

        // Render a labeled field only if value exists and is not '-'
        function renderField(label, value, className, useStrong = true) {
            if (value === null || value === undefined) return '';
            if (String(value).trim() === '' || String(value).trim() === '-') return '';
            const content = String(value).trim();
            if (label) {
                return `<div class="field ${className}">${useStrong ? `<strong>${label}</strong> ` : ''}${content}</div>`;
            }
            return `<div class="field ${className}">${content}</div>`;
        }

        function getAlbumSearchQuery() {
            const searchInput = document.getElementById('album-search-input');
            return searchInput ? searchInput.value.trim().toLowerCase() : '';
        }

        function getFilteredCds() {
            if (!cachedData || !Array.isArray(cachedData.cds)) return [];
            const query = getAlbumSearchQuery();
            if (!query) return cachedData.cds;

            return cachedData.cds.filter(cd => {
                const albumTitle = (cd.albumTitle || '').toString().toLowerCase();
                const artistName = (cd.artistName || '').toString().toLowerCase();
                return albumTitle.includes(query) || artistName.includes(query);
            });
        }

        function applyAlbumSearch() {
            renderTable(getFilteredCds());
        }

        // Function to render table rows
        function renderTable(cds) {
            const tableBody = document.getElementById('cdTableBody');
            tableBody.innerHTML = ''; // Clear existing rows
            
            cds.forEach(cd => {
                const row = document.createElement('tr');
                row.className = 'cd-row';

                row.innerHTML = `
                    <td class="col-release">
                        <div class="release-container">
                            <img class="album-cover" src="${cd.imageUrl || 'placeholder.png'}" alt="${cd.albumTitle}">
                            <div class="release-text">
                                <div class="field album-title">${cd.albumTitle}</div>
                                <div class="field artist-name">${cd.artistName}</div>
                            </div>
                        </div>
                    </td>
                    <td class="col-catalog">
                        ${renderField('Label:', cd.label, 'label')}
                        ${renderField('Catalog Nº:', cd.catalogNumber, 'catalog-number')}
                    </td>
                    <td class="col-identification">
                        ${renderField('Matrix:', cd.matrix, 'matrix')}
                        ${renderField("SID's:", cd.sids, 'sids')}
                        ${ (cd.year && cd.region && String(cd.year).trim() !== '-' && String(cd.region).trim() !== '-') ? `<div class="field year-region">${cd.year} - ${cd.region}</div>` : (cd.year && String(cd.year).trim() !== '-' ? `<div class="field year-region">${cd.year}</div>` : (cd.region && String(cd.region).trim() !== '-' ? `<div class="field year-region">${cd.region}</div>` : '')) }
                    </td>
                    <td class="col-acquisition">
                        ${renderField('', cd.dateAcquisition, 'date', false)}
                        ${ cd.price && String(cd.price).trim() !== '-' ? `<div class="field price">${formatPrice(cd.price)}</div>` : '' }
                    </td>
                    <td class="col-rating">
                        <div class="field rating">${generateStars(cd.rating)}</div>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Helper function to strip leading articles for sorting
        function stripArticle(name) {
            return name.replace(/^the\s+/i, '');
        }

        // Sort by artist name
        function sortByArtist() {
            if (!cachedData) return;

            // Toggle sort direction FIRST
            sortAscendingArtist = !sortAscendingArtist;

            cachedData.cds.sort((a, b) => {
                const nameA = stripArticle((a.artistName || '').toLowerCase());
                const nameB = stripArticle((b.artistName || '').toLowerCase());
                
                if (sortAscendingArtist) {
                    return nameA.localeCompare(nameB);
                } else {
                    return nameB.localeCompare(nameA);
                }
            });

            // Update button appearance
            const sortBtn = document.getElementById('sort-artist-btn');
            if (sortAscendingArtist) {
                sortBtn.classList.remove('descending');
                sortBtn.classList.add('ascending');
            } else {
                sortBtn.classList.add('descending');
                sortBtn.classList.remove('ascending');
            }

            // Re-render table (respect active search filter)
            applyAlbumSearch();
        }

        // Sort by year
        function sortByYear() {
            if (!cachedData) return;

            // Toggle sort direction FIRST
            sortAscendingYear = !sortAscendingYear;

            cachedData.cds.sort((a, b) => {
                // Extract year number from strings like "Repress(ca. 2012)" or "2012"
                const yearMatchA = (a.year || '').match(/\d{4}/);
                const yearMatchB = (b.year || '').match(/\d{4}/);
                const yearA = yearMatchA ? parseInt(yearMatchA[0]) : 0;
                const yearB = yearMatchB ? parseInt(yearMatchB[0]) : 0;
                
                // Put items without year at the bottom
                if (yearA === 0 && yearB === 0) return 0;
                if (yearA === 0) return 1;
                if (yearB === 0) return -1;
                
                if (sortAscendingYear) {
                    return yearA - yearB;
                } else {
                    return yearB - yearA;
                }
            });

            // Update button appearance
            const sortBtn = document.getElementById('sort-year-btn');
            if (sortAscendingYear) {
                sortBtn.classList.add('descending');
                sortBtn.classList.remove('ascending');
            } else {
                sortBtn.classList.remove('descending');
                sortBtn.classList.add('ascending');
            }

            // Re-render table (respect active search filter)
            applyAlbumSearch();
        }

        // Sort by date
        function sortByDate() {
            if (!cachedData) return;

            // Toggle sort direction FIRST
            sortAscendingDate = !sortAscendingDate;

            // Helper function to parse DD/MM/YYYY format
            function parseDate(dateStr) {
                if (!dateStr || dateStr.trim() === '') return null;
                const parts = dateStr.trim().split('/');
                if (parts.length === 3) {
                    const day = parseInt(parts[0]);
                    const month = parseInt(parts[1]) - 1;
                    const year = parseInt(parts[2]);
                    return new Date(year, month, day);
                }
                return null;
            }

            cachedData.cds.sort((a, b) => {
                const dateA = parseDate(a.dateAcquisition);
                const dateB = parseDate(b.dateAcquisition);
                
                // Put items without date at the bottom
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;
                
                if (sortAscendingDate) {
                    return dateA - dateB;
                } else {
                    return dateB - dateA;
                }
            });

            // Update button appearance
            const sortBtn = document.getElementById('sort-date-btn');
            if (sortAscendingDate) {
                sortBtn.classList.remove('descending');
                sortBtn.classList.add('ascending');
            } else {
                sortBtn.classList.add('descending');
                sortBtn.classList.remove('ascending');
            }

            // Re-render table (respect active search filter)
            applyAlbumSearch();
        }

        // Sort by price
        function sortByPrice() {
            if (!cachedData) return;

            // Toggle sort direction FIRST
            sortAscendingPrice = !sortAscendingPrice;

            cachedData.cds.sort((a, b) => {
                // Extract price number from strings like "15,50€" or "15.50€"
                const priceStrA = (a.price || '').toString().trim();
                const priceStrB = (b.price || '').toString().trim();
                const hasA = priceStrA && priceStrA !== '' && priceStrA !== '-';
                const hasB = priceStrB && priceStrB !== '' && priceStrB !== '-';
                
                // Put items without price at the bottom
                if (!hasA && !hasB) return 0;
                if (!hasA) return 1;
                if (!hasB) return -1;
                
                const priceA = parseFloat(priceStrA.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
                const priceB = parseFloat(priceStrB.replace(/[^0-9.,]/g, '').replace(',', '.')) || 0;
                
                if (sortAscendingPrice) {
                    return priceA - priceB;
                } else {
                    return priceB - priceA;
                }
            });

            // Update button appearance
            const sortBtn = document.getElementById('sort-price-btn');
            if (sortAscendingPrice) {
                sortBtn.classList.remove('descending');
                sortBtn.classList.add('ascending');
            } else {
                sortBtn.classList.add('descending');
                sortBtn.classList.remove('ascending');
            }

            // Re-render table (respect active search filter)
            applyAlbumSearch();
        }

        // Sort by rating
        function sortByRating() {
            if (!cachedData) return;

            // Toggle sort direction FIRST
            sortAscendingRating = !sortAscendingRating;

            cachedData.cds.sort((a, b) => {
                const ratingA = parseFloat(a.rating) || 0;
                const ratingB = parseFloat(b.rating) || 0;
                
                // Put items without rating at the bottom
                if (ratingA === 0 && ratingB === 0) return 0;
                if (ratingA === 0) return 1;
                if (ratingB === 0) return -1;
                
                if (sortAscendingRating) {
                    return ratingA - ratingB;
                } else {
                    return ratingB - ratingA;
                }
            });

            // Update button appearance
            const sortBtn = document.getElementById('sort-rating-btn');
            if (sortAscendingRating) {
                sortBtn.classList.remove('descending');
                sortBtn.classList.add('ascending');
            } else {
                sortBtn.classList.add('descending');
                sortBtn.classList.remove('ascending');
            }

            // Re-render table (respect active search filter)
            applyAlbumSearch();
        }

        // Fetch and parse the JSON data (cache-busted)
        fetch('cdexcel.json?cb=' + Date.now())
            .then(response => response.json())
            .then(data => {
                cachedData = data;
                applyAlbumSearch();

                // Add click handlers to sort buttons
                document.getElementById('sort-artist-btn').addEventListener('click', sortByArtist);
                document.getElementById('sort-year-btn').addEventListener('click', sortByYear);
                document.getElementById('sort-date-btn').addEventListener('click', sortByDate);
                document.getElementById('sort-price-btn').addEventListener('click', sortByPrice);
                document.getElementById('sort-rating-btn').addEventListener('click', sortByRating);

                const searchToggle = document.getElementById('release-search-toggle');
                const searchPanel = document.getElementById('release-search-panel');
                const searchInput = document.getElementById('album-search-input');

                if (searchToggle && searchPanel && searchInput) {
                    searchToggle.addEventListener('click', function() {
                        const isOpen = searchPanel.classList.toggle('open');
                        searchPanel.setAttribute('aria-hidden', (!isOpen).toString());
                        searchToggle.classList.toggle('active', isOpen);

                        if (isOpen) {
                            searchInput.focus();
                        } else {
                            searchInput.value = '';
                            applyAlbumSearch();
                        }
                    });

                    searchInput.addEventListener('input', applyAlbumSearch);

                    searchInput.addEventListener('keydown', function(event) {
                        if (event.key === 'Escape') {
                            searchPanel.classList.remove('open');
                            searchPanel.setAttribute('aria-hidden', 'true');
                            searchToggle.classList.remove('active');
                            searchInput.value = '';
                            applyAlbumSearch();
                            searchToggle.focus();
                        }
                    });
                }
            })
            .catch(error => console.error('Error loading data:', error));
    </script>
</body>
</html>
